{% extends "base.html" %}
{% load widget_tweaks %}

{% block head %}
  {{ block.super }}
  <link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet" />
{% endblock %}

{% block content %}
<div class="flex justify-center items-center min-h-screen bg-gray-100 px-4">
  <div dir="rtl" class="w-full max-w-2xl bg-white shadow-md rounded-2xl p-6">
    <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center">
      إدخال مخزون
    </h2>

    <form method="POST" class="space-y-4" id="stock-entry-form">
      {% csrf_token %}

      <div class="p-2">
        <label for="{{ form.client.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          {{ form.client.label }}{% if form.client.field.required %}<span class="text-red-500"> *</span>{% endif %}
        </label>
        {{ form.client|add_class:"tom-select w-full px-4 py-2 border rounded-md focus:ring focus:ring-indigo-300 text-right" }}
        {% if form.client.help_text %}
          <p class="text-sm text-gray-500 mt-1">{{ form.client.help_text }}</p>
        {% endif %}
        {% for error in form.client.errors %}
          <p class="text-sm text-red-600 mt-1">{{ error }}</p>
        {% endfor %}
      </div>

      {{ formset.management_form }}

      <div id="formset-container">
        {% for subform in formset %}
          <div class="border border-gray-300 rounded-lg p-4 mb-4 product-form">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 relative">

              <button type="button" class="remove-form absolute top-0 left-0 bg-red-500 text-white rounded px-2 py-1 hover:bg-red-600" style="z-index:10;">
                حذف
              </button>

              <div>
                <label for="{{ subform.product.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                  {{ subform.product.label }}{% if subform.product.field.required %}<span class="text-red-500"> *</span>{% endif %}
                </label>
                {{ subform.product|add_class:"tom-select w-full px-4 py-2 border rounded-md focus:ring focus:ring-indigo-300 text-right" }}
                {% if subform.product.help_text %}
                  <p class="text-sm text-gray-500 mt-1">{{ subform.product.help_text }}</p>
                {% endif %}
                {% for error in subform.product.errors %}
                  <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                {% endfor %}
              </div>

              <div>
                <label for="{{ subform.expiry_date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                  {{ subform.expiry_date.label }}{% if subform.expiry_date.field.required %}<span class="text-red-500"> *</span>{% endif %}
                </label>
                {{ subform.expiry_date|add_class:"w-full px-4 py-2 border rounded-md focus:ring focus:ring-indigo-300 text-right" }}
                {% if subform.expiry_date.help_text %}
                  <p class="text-sm text-gray-500 mt-1">{{ subform.expiry_date.help_text }}</p>
                {% endif %}
                {% for error in subform.expiry_date.errors %}
                  <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                {% endfor %}
              </div>

              <div>
                <label for="{{ subform.packet_count.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
                  {{ subform.packet_count.label }}{% if subform.packet_count.field.required %}<span class="text-red-500"> *</span>{% endif %}
                </label>
                {{ subform.packet_count|add_class:"w-full px-4 py-2 border rounded-md focus:ring focus:ring-indigo-300 text-right" }}
                {% if subform.packet_count.help_text %}
                  <p class="text-sm text-gray-500 mt-1">{{ subform.packet_count.help_text }}</p>
                {% endif %}
                {% for error in subform.packet_count.errors %}
                  <p class="text-sm text-red-600 mt-1">{{ error }}</p>
                {% endfor %}
              </div>
            </div>
          </div>
        {% endfor %}
      </div>

      <button type="button" id="add-product-btn" class="w-full bg-green-600 py-2 px-4 rounded-md hover:bg-green-700 transition mb-4">
        إضافة منتج آخر +
      </button>

      <div>
        <button type="submit" class="w-full bg-indigo-600 py-2 px-4 rounded-md hover:bg-indigo-700 transition">
          حفظ الإدخال
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Initialize Tom Select for all tom-select fields
      function initTomSelect(selector) {
        new TomSelect(selector, {
          maxItems: 1,
          searchField: ['text'],
          placeholder: "ابحث واختر...",
          dropdownDirection: "auto",
          allowEmptyOption: false,
        });
      }

      // Initialize existing selects
      document.querySelectorAll('.tom-select').forEach(el => initTomSelect(el));

      // Formset container
      const formsetContainer = document.getElementById('formset-container');
      const addBtn = document.getElementById('add-product-btn');

      addBtn.addEventListener('click', function() {
        // Get total forms count
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        const currentFormCount = parseInt(totalForms.value);

        // Clone empty form template
        const emptyFormTemplate = document.getElementById('empty-form-template').innerHTML;
        const newFormHtml = emptyFormTemplate.replace(/__prefix__/g, currentFormCount);

        // Insert new form
        const newDiv = document.createElement('div');
        newDiv.classList.add('border', 'border-gray-300', 'rounded-lg', 'p-4', 'mb-4', 'product-form');
        newDiv.innerHTML = newFormHtml;

        // Append remove button
        const removeBtn = document.createElement('button');
        removeBtn.type = "button";
        removeBtn.className = "remove-form absolute top-0 left-0 bg-red-500 text-white rounded px-2 py-1 hover:bg-red-600";
        removeBtn.textContent = "حذف";
        removeBtn.style.zIndex = 10;
        newDiv.querySelector('.grid').appendChild(removeBtn);

        formsetContainer.appendChild(newDiv);

        // Update total forms count
        totalForms.value = currentFormCount + 1;

        // Initialize Tom Select on new selects
        newDiv.querySelectorAll('.tom-select').forEach(el => initTomSelect(el));

        // Remove form handler
        removeBtn.addEventListener('click', () => {
          newDiv.remove();
          updateTotalForms();
        });
      });

      // Remove form buttons for initial forms
      formsetContainer.querySelectorAll('.remove-form').forEach(btn => {
        btn.addEventListener('click', e => {
          const formDiv = e.target.closest('.product-form');
          formDiv.remove();
          updateTotalForms();
        });
      });

      function updateTotalForms() {
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        totalForms.value = formsetContainer.querySelectorAll('.product-form').length;
      }
    });
  </script>

  {# Hidden empty form template for cloning #}
  <script type="text/template" id="empty-form-template">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 relative">
      <div>
        <label for="id_form-__prefix__-product" class="block text-sm font-medium text-gray-700 mb-1">
          المنتج <span class="text-red-500"> *</span>
        </label>
        <select name="form-__prefix__-product" class="tom-select w-full px-4 py-2 border rounded-md focus:ring focus:ring-indigo-300 text-right" id="id_form-__prefix__-product" required>
          {% for product in products %}
            <option value="{{ product.id }}">{{ product.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label for="id_form-__prefix__-expiry_date" class="block text-sm font-medium text-gray-700 mb-1">
          تاريخ الانتهاء <span class="text-red-500"> *</span>
        </label>
        <input type="date" name="form-__prefix__-expiry_date" class="w-full px-4 py-2 border rounded-md focus:ring focus:ring-indigo-300 text-right" id="id_form-__prefix__-expiry_date" required />
      </div>
      <div>
        <label for="id_form-__prefix__-packet_count" class="block text-sm font-medium text-gray-700 mb-1">
          عدد العلب <span class="text-red-500"> *</span>
        </label>
        <input type="number" name="form-__prefix__-packet_count" class="w-full px-4 py-2 border rounded-md focus:ring focus:ring-indigo-300 text-right" id="id_form-__prefix__-packet_count" required />
      </div>
    </div>
  </script>
{% endblock %}
